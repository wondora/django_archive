<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>W Archive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; }
        .sidebar { width: 280px; height: 100vh; background: white; border-right: 1px solid #eee; position: fixed; overflow-y: auto; z-index: 100; }
        .main-content { margin-left: 280px; padding: 40px; min-height: 100vh; }
        
        /* [트리 구조 가독성 최적화] */
        .subfolder-group { display: none; } /* 기본적으로 모두 닫힘 */
        .folder-tree-item { margin-left: 4px; }
        .toggle-icon { transition: transform 0.2s ease; }
        .active-folder { color: #0d6efd !important; }

        /* 드래그 핸들 및 링크 */
        .drag-handle { cursor: grab; color: #ccc; transition: color 0.2s; }
        .drag-handle:hover { color: #0d6efd; }
        a { -webkit-user-drag: none; } 

        /* 툴바 및 UI */
        .toolbar-card { background: white; border-radius: 16px; padding: 1.25rem; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 2rem; }
        .custom-input-group { background: #f1f3f5; border-radius: 12px; padding: 4px 8px; border: 2px solid transparent; }
        .custom-input-group:focus-within { background: white; border-color: #0d6efd; }
        .btn-elegant { border-radius: 10px; padding: 10px 20px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        
        #drop-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:9999; color:white; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="drop-overlay">
    <i class="bi bi-cloud-arrow-up-fill" style="font-size: 5rem;"></i>
    <h2 class="mt-3 fw-bold">파일을 놓아 업로드하세요</h2>
</div>

<div class="sidebar p-4">
    <h4 class="mb-4 fw-bold text-primary"><i class="bi bi-cloud-fill me-2"></i>W Archive</h4>
    <nav class="nav flex-column">
        <a href="{% url 'root' %}" class="nav-link {% if not current_folder %}active{% endif %} drop-zone" data-folder-id="">
            <i class="bi bi-hdd-stack me-2"></i> 내 드라이브
        </a>
        <hr>
        <div class="small text-muted mb-2 px-2">폴더 목록</div>
        <div id="folder-tree-root">
            {% include "core/folder_tree.html" with folders=all_folders_root %}
        </div>
    </nav>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'root' %}" class="text-decoration-none">Home</a></li>
                {% for b in breadcrumbs %}<li class="breadcrumb-item small"><a href="{% url 'folder' b.id %}" class="text-decoration-none">{{ b.name }}</a></li>{% endfor %}
            </ol>
        </nav>
        <div class="small fw-bold">{{ user.username }}님 <a href="{% url 'logout' %}" class="ms-2 btn btn-sm btn-outline-danger">로그아웃</a></div>
    </div>

    <div class="toolbar-card d-flex justify-content-end align-items-center gap-3">
        <div style="max-width: 400px; flex-grow: 1;">
            <form action="{% if current_folder %}{% url 'create_folder' current_folder.id %}{% else %}{% url 'create_root_folder' %}{% endif %}" method="post" class="m-0 d-flex gap-2">
                {% csrf_token %}
                <div class="custom-input-group flex-grow-1 d-flex align-items-center">
                    <input type="text" name="folder_name" class="form-control border-0 bg-transparent" placeholder="새 폴더 이름" required>
                </div>
                <button type="submit" class="btn btn-primary btn-elegant btn-create"><i class="bi bi-plus-lg"></i>생성</button>
            </form>
        </div>
        {% if current_folder %}
        <input type="file" id="manual-upload" multiple class="d-none" onchange="handleManualUpload(this)">
        <button type="button" class="btn btn-outline-primary btn-elegant btn-upload" onclick="document.getElementById('manual-upload').click()">
            <i class="bi bi-upload"></i>업로드
        </button>
        {% endif %}
    </div>

    <div class="card shadow-sm border-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light"><tr><th width="50"></th><th>이름</th><th>크기</th><th>날짜</th><th class="text-end pe-4">작업</th></tr></thead>
            <tbody>
                {% for folder in folders %}
                <tr>
                    <td class="text-center"><i class="bi bi-grip-vertical drag-handle" draggable="true" ondragstart="handleDragStart(event, 'folder', '{{ folder.id }}')"></i></td>
                    <td><a href="{% url 'folder' folder.id %}" class="text-decoration-none text-dark drop-zone" data-folder-id="{{ folder.id }}"><i class="bi bi-folder2-fill text-warning me-2"></i>{{ folder.name }}</a></td>
                    <td class="text-muted">-</td><td class="small">{{ folder.created_at|date:"Y.m.d" }}</td>
                    <td class="text-end pe-4"><a href="{% url 'delete_item' folder.id %}?type=folder" class="text-secondary" onclick="return confirm('삭제?');"><i class="bi bi-trash"></i></a></td>
                </tr>
                {% endfor %}
                {% for file in files %}
                <tr>
                    <td class="text-center"><i class="bi bi-grip-vertical drag-handle" draggable="true" ondragstart="handleDragStart(event, 'file', '{{ file.id }}')"></i></td>
                    <td><a href="{% url 'download_file' file.id %}" class="text-decoration-none text-dark"><i class="bi bi-file-earmark-text text-primary me-2"></i>{{ file.name }}</a></td>
                    <td class="small">{{ file.size|filesizeformat }}</td><td class="small">{{ file.created_at|date:"Y.m.d" }}</td>
                    <td class="text-end pe-4"><a href="{% url 'delete_item' file.id %}?type=file" class="text-secondary" onclick="return confirm('삭제?');"><i class="bi bi-trash"></i></a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // 1. 폴더 토글 & 네비게이션 로직 (스마트 토글)
    // ==========================================
    
    function handleFolderClick(event, elementId, isCurrentFolder) {
        if (isCurrentFolder) {
            event.preventDefault(); // 현재 폴더 클릭 시 이동 방지(깜빡임 해결)
            const group = document.getElementById(elementId);
            const icon = event.currentTarget.closest('.drop-zone').querySelector('.toggle-icon');
            
            if (group) {
                if (group.style.display === "block") {
                    group.style.display = "none";
                    if (icon) icon.classList.replace("bi-chevron-down", "bi-chevron-right");
                } else {
                    group.style.display = "block";
                    if (icon) icon.classList.replace("bi-chevron-right", "bi-chevron-down");
                }
            }
        }
    }

    function toggleSubfolders(event, elementId) {
        event.stopPropagation();
        const group = document.getElementById(elementId);
        const icon = event.currentTarget;
        if (group.style.display === "none") {
            group.style.display = "block";
            icon.classList.replace("bi-chevron-right", "bi-chevron-down");
        } else {
            group.style.display = "none";
            icon.classList.replace("bi-chevron-down", "bi-chevron-right");
        }
    }

    // ==========================================
    // 2. 드래그 앤 드롭 (이동) 로직 - 복구됨!
    // ==========================================

    let isInternalDragging = false;

    // 드래그 시작 (파일/폴더 공통)
    function handleDragStart(e, type, id) {
        isInternalDragging = true;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("item_id", id);
        e.dataTransfer.setData("item_type", type);
        // 드래그 중인 요소 투명도 조절 등 시각적 효과 추가 가능
    }

    document.addEventListener('dragend', () => isInternalDragging = false);

    // 드롭존 이벤트 연결 (폴더 트리 및 리스트의 모든 drop-zone)
    document.addEventListener("DOMContentLoaded", () => {
        // [초기화] 모든 하위 폴더 닫고, 현재 경로만 열기
        document.querySelectorAll('.subfolder-group').forEach(el => el.style.display = 'none');
        
        const activeLink = document.querySelector(".active-folder");
        if (activeLink) {
            let parent = activeLink.closest(".subfolder-group");
            while (parent) {
                parent.style.display = "block";
                const toggleBtn = parent.previousElementSibling.querySelector(".toggle-icon");
                if (toggleBtn) toggleBtn.classList.replace("bi-chevron-right", "bi-chevron-down");
                parent = parent.parentElement.closest(".subfolder-group");
            }
            const currentId = activeLink.closest(".drop-zone").getAttribute("data-folder-id");
            const selfSubGroup = document.getElementById(`sub-${currentId}`);
            if (selfSubGroup) {
                selfSubGroup.style.display = "block";
                const selfToggle = activeLink.closest(".drop-zone").querySelector(".toggle-icon");
                if (selfToggle) selfToggle.classList.replace("bi-chevron-right", "bi-chevron-down");
            }
        }

        // [이동 로직] 드롭존에 이벤트 리스너 추가
        document.querySelectorAll('.drop-zone').forEach(zone => {
            // 드래그해서 폴더 위로 올라왔을 때
            zone.addEventListener('dragover', (e) => {
                if (isInternalDragging) {
                    e.preventDefault(); // 드롭 허용
                    zone.classList.add('drop-target'); // 시각적 피드백 (파란 테두리 등)
                }
            });

            // 드래그해서 폴더 밖으로 나갔을 때
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drop-target');
            });

            // 놓았을 때 (실제 이동 처리)
            zone.addEventListener('drop', async (e) => {
                if (!isInternalDragging) return;
                e.preventDefault();
                zone.classList.remove('drop-target');

                const itemId = e.dataTransfer.getData("item_id");
                const itemType = e.dataTransfer.getData("item_type");
                const targetId = zone.getAttribute('data-folder-id'); // 도착지 폴더 ID

                // 자기 자신에게 드롭하거나, ID가 없으면 무시
                if (itemId && targetId && itemId !== targetId) {
                    if (confirm('선택한 항목을 여기로 이동하시겠습니까?')) {
                        try {
                            const response = await fetch("{% url 'move_item' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    item_id: itemId,
                                    item_type: itemType,
                                    target_id: targetId
                                })
                            });
                            
                            if (response.ok) {
                                window.location.reload(); // 성공 시 새로고침
                            } else {
                                alert('이동에 실패했습니다.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('오류가 발생했습니다.');
                        }
                    }
                }
            });
        });
    });

    // ==========================================
    // 3. 파일 업로드 로직
    // ==========================================
    // (기존 코드 유지)
    const overlay = document.getElementById('drop-overlay');
    function handleManualUpload(input) { /* ... 기존 로직 ... */ }
    window.addEventListener('dragenter', (e) => {
        if (!isInternalDragging && e.dataTransfer.types.includes('Files')) overlay.style.display = 'flex';
    });
    overlay.addEventListener('dragleave', (e) => { if (e.relatedTarget === null) overlay.style.display = 'none'; });
    overlay.addEventListener('drop', (e) => { /* ... 기존 업로드 로직 ... */ });
</script>
</body>
</html>